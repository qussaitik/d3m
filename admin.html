<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Ø¹Ø§Ù„Ù… Ø§Ù„Ù…ØµÙŠØ¨Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --p: #6c5ce7; --s: #00cec9; --bg: #f4f7fe; --danger: #ff7675; --success: #55efc4; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); padding: 20px; color: #2d3436; }
        .container { max-width: 1000px; margin: auto; }
        
        /* Ù‚ÙÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
        #lock { background: white; padding: 50px 30px; border-radius: 30px; text-align: center; margin-top: 80px; box-shadow: 0 20px 40px rgba(0,0,0,0.05); border: 1px solid #edf2f7; }
        #lock h2 { margin-bottom: 20px; color: var(--p); font-weight: 900; }
        .login-input { width: 100%; max-width: 300px; padding: 15px; border-radius: 15px; border: 2px solid #eee; text-align: center; margin-bottom: 15px; outline: none; transition: 0.3s; }
        .login-input:focus { border-color: var(--p); }
        .login-btn { width: 100%; max-width: 300px; padding: 15px; background: var(--p); color: white; border: none; border-radius: 15px; font-weight: 900; cursor: pointer; }

        /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #edf2f7; }
        h3 { margin-bottom: 20px; font-weight: 900; color: var(--p); display: flex; align-items: center; gap: 10px; }

        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f8f9fa; }
        .user-info { flex: 1; }
        .user-info span { display: block; font-weight: 900; font-size: 16px; }
        .user-info small { color: var(--p); font-weight: 700; font-size: 15px; }
        
        .balance-ctrl { display: flex; gap: 10px; align-items: center; }
        .amt-input { width: 90px; padding: 10px; border-radius: 12px; border: 2px solid #eee; text-align: center; font-weight: 900; }
        .btn-action { width: 40px; height: 40px; border: none; border-radius: 12px; color: white; cursor: pointer; font-size: 20px; font-weight: 900; transition: 0.2s; }
        .btn-action:active { transform: scale(0.9); }

        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
        .order-item { padding: 20px; border-bottom: 1px solid #f8f9fa; display: flex; flex-wrap: wrap; justify-content: space-between; gap: 15px; }
        .order-details { flex: 2; min-width: 250px; }
        .order-status-ctrl { flex: 1; display: flex; gap: 10px; align-items: center; justify-content: flex-end; }
        select { padding: 10px; border-radius: 12px; border: 1px solid #eee; font-family: 'Tajawal'; font-weight: 700; outline: none; }
        .save-status-btn { background: var(--p); color: white; border: none; padding: 10px 15px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div id="lock">
            <h2>ğŸ›¡ï¸ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
            <input type="password" id="admin_p" class="login-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <br>
            <button onclick="checkAdmin()" class="login-btn">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <div id="main_ui" style="display:none">
            <div class="header">
                <h1 style="font-weight: 900; color: #2d3436;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
                <button onclick="loadData()" style="padding: 10px 20px; border-radius: 15px; border: 1px solid #ddd; background: white; cursor: pointer; font-weight: 700;">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>

            <div class="card">
                <h3>ğŸ’° Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø£Ø±ØµØ¯Ø©</h3>
                <div id="users_list">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†...</div>
            </div>

            <div class="card">
                <h3>ğŸ“¦ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</h3>
                <div id="orders_list">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
            </div>
        </div>
    </div>

    <script>
        const url = "https://script.google.com/macros/s/AKfycbxCZH5YiykKS0_PS4rs2nsUbXDiXZfBelymkvieUeupMdJO4VxTsyTcn80sEdT6gO5o/exec";
        
        function checkAdmin() {
            if(document.getElementById('admin_p').value === "0598787757") {
                document.getElementById('lock').style.display='none';
                document.getElementById('main_ui').style.display='block';
                loadData();
            } else { alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙ„Ø· ÙŠØ§ Ù…Ø¯ÙŠØ±!"); }
        }

        async function loadData() {
            try {
                const [bRes, oRes] = await Promise.all([ 
                    fetch(url+"?action=getBalances").then(r=>r.json()), 
                    fetch(url+"?action=getOrders").then(r=>r.json()) 
                ]);
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                let bHtml = "";
                Object.keys(bRes).forEach(u => {
                    if(u !== "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…") {
                        bHtml += `
                        <div class="user-item">
                            <div class="user-info">
                                <span>ğŸ‘¤ ${u}</span>
                                <small>Ø§Ù„Ø±ØµÙŠØ¯: $${parseFloat(bRes[u]).toFixed(4)}</small>
                            </div>
                            <div class="balance-ctrl">
                                <input type="number" id="i_${u}" class="amt-input" placeholder="0.00" step="0.01">
                                <button class="btn-action" style="background:var(--success)" onclick="updateBal('${u}','add')">+</button>
                                <button class="btn-action" style="background:var(--danger)" onclick="updateBal('${u}','sub')">-</button>
                            </div>
                        </div>`;
                    }
                });
                document.getElementById('users_list').innerHTML = bHtml;

                // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                document.getElementById('orders_list').innerHTML = oRes.reverse().map((o, idx) => `
                    <div class="order-item">
                        <div class="order-details">
                            <b>${o.user}</b> - ${o.service} (${o.qty})<br>
                            <small style="color:#888">${o.link} | ${o.date}</small>
                        </div>
                        <div class="order-status-ctrl">
                            <select id="st_${idx}">
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©" ${o.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' ? 'selected' : ''}>â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                                <option value="Ù…ÙƒØªÙ…Ù„" ${o.status === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>âœ… Ù…ÙƒØªÙ…Ù„</option>
                                <option value="Ù…Ù„ØºÙŠ" ${o.status === 'Ù…Ù„ØºÙŠ' ? 'selected' : ''}>âŒ Ù…Ù„ØºÙŠ</option>
                            </select>
                            <button class="save-status-btn" onclick="updateStatus('${o.user}', '${o.date}', ${idx})">Ø­ÙØ¸</button>
                        </div>
                    </div>`).join('');
            } catch (e) { console.error(e); }
        }

        async function updateBal(u, t) {
            const a = document.getElementById('i_'+u).value;
            if(!a) return;
            await fetch(url, { method:"POST", body:JSON.stringify({action:"updateBalance", user:u, amount:a, type:t}) });
            loadData();
        }

        async function updateStatus(u, d, id) {
            const status = document.getElementById('st_'+id).value;
            const btn = event.target;
            btn.innerText = ".."; btn.disabled = true;
            await fetch(url, { method: "POST", body: JSON.stringify({action: "updateOrderStatus", user: u, date: d, status: status}) });
            btn.innerText = "ØªÙ… âœ…";
            setTimeout(() => { btn.innerText = "Ø­ÙØ¸"; btn.disabled = false; }, 2000);
        }
    </script>
</body>
</html>
