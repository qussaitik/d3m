<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø§Ù„Ù…ØµÙŠØ¨Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --bg: #f8f9fd;
            --card-bg: #ffffff;
            --text: #2d3436;
        }

        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; text-align: center; }
        
        #admin-lock { position: fixed; inset: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-box { background: white; padding: 40px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 320px; border: 1px solid #edf2f7; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 12px; border: 2px solid #f1f2f6; text-align: center; font-family: 'Tajawal'; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 800; }

        #admin-main { display: none; max-width: 700px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #edf2f7; }
        
        .user-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #fcfcfd; padding: 15px; border-radius: 15px; margin-bottom: 10px; 
            border: 1px solid #f1f2f6; transition: 0.3s;
        }
        .user-row:hover { border-color: var(--primary); }

        .bal-val { color: var(--primary); font-size: 20px; font-weight: 900; min-width: 80px; }
        .controls { display: flex; align-items: center; gap: 5px; }
        .amt-input { width: 70px !important; margin: 0 !important; padding: 8px !important; }
        
        .btn-add { background: #2ecc71; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-sub { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .status { font-size: 12px; color: #b2bec3; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="admin-lock">
        <div class="login-box">
            <h2 style="color: var(--primary)">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸ›¡ï¸</h2>
            <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø®Ø§ØµØ©">
            <button class="btn-main" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="admin-main">
        <div class="card">
            <h2 style="color: var(--primary); margin-top: 0;">ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            <p style="font-size: 14px; color: #636e72;">Ø£ÙŠ Ø§Ø³Ù… ØªØ¶ÙŠÙÙ‡ ÙÙŠ Ø§Ù„Ø´ÙŠØª Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
            <div id="users-list">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... ğŸ”ƒ</div>
            <div class="status" id="last-sync"></div>
        </div>

        <div class="card">
            <h3 style="color: var(--text)">ğŸ“¦ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ø®ÙŠØ±</h3>
            <div id="orders-list" style="font-size: 13px; text-align: right;"></div>
        </div>
        
        <button onclick="location.reload()" style="background:none; border:none; color:var(--primary); cursor:pointer; font-weight:bold;">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbz33uo9f-5eVXAFaI6qfk5ce-mgSX-tQ0q7HjDlYFa4akBvn3NuaUh5fuqYYMc1FEA/exec";

        function login() {
            const p = document.getElementById('adminPass').value;
            if (p === "0598787757") { // ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù† ØªØ¨Ø¹ØªÙƒ
                document.getElementById('admin-lock').style.display = 'none';
                document.getElementById('admin-main').style.display = 'block';
                loadData();
            } else {
                alert("Ø§Ù„Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ ØºÙ„Ø· ÙŠØ§ Ù…Ø¯ÙŠØ±!");
            }
        }

        async function loadData() {
            const listDiv = document.getElementById('users-list');
            const ordersDiv = document.getElementById('orders-list');
            
            try {
                const [balRes, ordRes] = await Promise.all([
                    fetch(scriptURL + "?action=getBalances").then(r => r.json()),
                    fetch(scriptURL + "?action=getOrders").then(r => r.json())
                ]);

                // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ù„ÙƒÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ø´ÙŠØª
                listDiv.innerHTML = "";
                Object.keys(balRes).forEach(u => {
                    if (u === "" || u === "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…") return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ø³Ø·ÙˆØ± Ø§Ù„ÙØ§Ø¶ÙŠØ©
                    
                    let b = balRes[u] || 0;
                    listDiv.innerHTML += `
                        <div class="user-row">
                            <div style="text-align:right">
                                <b style="display:block">ğŸ‘‘ ${u}</b>
                            </div>
                            <div class="bal-val" id="v_${u}">$${b}</div>
                            <div class="controls">
                                <input type="number" id="i_${u}" class="amt-input" placeholder="0">
                                <button class="btn-add" onclick="update('${u}','add')">+</button>
                                <button class="btn-sub" onclick="update('${u}','sub')">-</button>
                            </div>
                        </div>`;
                });

                // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                ordersDiv.innerHTML = ordRes.reverse().slice(0, 8).map(o => 
                    `<div style="border-bottom: 1px solid #f1f2f6; padding: 10px 0;">
                        <b>${o.user}</b> Ø·Ù„Ø¨ ${o.service} <br>
                        <small style="color:#b2bec3">${o.date}</small>
                    </div>`
                ).join('') || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹";

                document.getElementById('last-sync').innerText = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + new Date().toLocaleTimeString('ar-EG');

            } catch (e) {
                listDiv.innerHTML = "<p style='color:orange'>ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´ÙŠØª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.</p>";
            }
        }

        async function update(u, t) {
            const val = document.getElementById('i_'+u).value;
            if (!val || val <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹");
            
            const badge = document.getElementById('v_'+u);
            badge.innerText = "â³";
            
            try {
                await fetch(scriptURL, {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify({ action: "updateBalance", user: u, amount: val, type: t })
                });
                
                // Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª
                setTimeout(loadData, 2500);
            } catch (e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
                loadData();
            }
        }
    </script>
</body>
</html>
